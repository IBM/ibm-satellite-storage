---
apiVersion: v1
kind: List
metadata:
  name: gcp-compute-persistent-disk-csi-driver
  namespace: kube-system
  annotations:
    version: 1.7.1
    revision: 1
items:
  - apiVersion: v1
    kind: Namespace
    metadata:
      name: gce-pd-csi-driver
  - apiVersion: v1
    kind: Secret
    metadata:
      name: cloud-sa
      namespace: gce-pd-csi-driver
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    stringData:
      cloud-sa.json: |
        {
          "type": "service_account",
          "project_id": "{{{project_id}}}",
          "private_key_id": "{{{private_key_id}}}",
          "private_key": "{{{private_key}}}",
          "client_email": "{{{client_email}}}",
          "client_id": "{{{client_id}}}",
          "auth_uri": "{{{auth_uri}}}",
          "token_uri": "{{{token_uri}}}",
          "auth_provider_x509_cert_url": "{{{auth_provider_x509_cert_url}}}",
          "client_x509_cert_url": "{{{client_x509_cert_url}}}"
        }
    type: Opaque
  - apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: csi-gce-pd-controller-sa
      namespace: gce-pd-csi-driver
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
  - apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: csi-gce-pd-node-sa
      namespace: gce-pd-csi-driver
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1

  - apiVersion: policy/v1beta1
    kind: PodSecurityPolicy
    metadata:
      name: csi-gce-pd-controller-psp
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    spec:
      fsGroup:
        rule: RunAsAny
      hostNetwork: true
      runAsUser:
        rule: RunAsAny
      seLinux:
        rule: RunAsAny
      supplementalGroups:
        rule: RunAsAny
      volumes:
      - emptyDir
      - secret
  - apiVersion: policy/v1beta1
    kind: PodSecurityPolicy
    metadata:
      name: csi-gce-pd-node-psp
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    spec:
      allowedHostPaths:
      - pathPrefix: /var/data/kubelet/plugins_registry/
      - pathPrefix: /var/data/kubelet
      - pathPrefix: /var/data/kubelet/plugins/pd.csi.storage.gke.io/
      - pathPrefix: /dev
      - pathPrefix: /etc/udev
      - pathPrefix: /lib/udev
      - pathPrefix: /run/udev
      - pathPrefix: /sys
      fsGroup:
        rule: RunAsAny
      hostNetwork: true
      privileged: true
      runAsUser:
        rule: RunAsAny
      seLinux:
        rule: RunAsAny
      supplementalGroups:
        rule: RunAsAny
      volumes:
      - '*'
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
        k8s-app: gcp-compute-persistent-disk-csi-driver
      name: csi-gce-pd-leaderelection-role
      namespace: gce-pd-csi-driver
    rules:
    - apiGroups:
      - coordination.k8s.io
      resources:
      - leases
      verbs:
      - get
      - watch
      - list
      - delete
      - update
      - create
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: csi-gce-pd-attacher-role
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    rules:
    - apiGroups:
      - ""
      resources:
      - persistentvolumes
      verbs:
      - get
      - list
      - watch
      - update
      - patch
    - apiGroups:
      - ""
      resources:
      - nodes
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - storage.k8s.io
      resources:
      - csinodes
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - storage.k8s.io
      resources:
      - volumeattachments
      verbs:
      - get
      - list
      - watch
      - update
      - patch
    - apiGroups:
      - storage.k8s.io
      resources:
      - volumeattachments/status
      verbs:
      - patch
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: csi-gce-pd-controller-deploy
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    rules:
    - apiGroups:
      - policy
      resourceNames:
      - csi-gce-pd-controller-psp
      resources:
      - podsecuritypolicies
      verbs:
      - use
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: csi-gce-pd-node-deploy
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    rules:
    - apiGroups:
      - policy
      resourceNames:
      - csi-gce-pd-node-psp
      resources:
      - podsecuritypolicies
      verbs:
      - use
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: csi-gce-pd-provisioner-role
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    rules:
    - apiGroups:
      - ""
      resources:
      - persistentvolumes
      verbs:
      - get
      - list
      - watch
      - create
      - delete
    - apiGroups:
      - ""
      resources:
      - persistentvolumeclaims
      verbs:
      - get
      - list
      - watch
      - update
    - apiGroups:
      - storage.k8s.io
      resources:
      - storageclasses
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - ""
      resources:
      - events
      verbs:
      - list
      - watch
      - create
      - update
      - patch
    - apiGroups:
      - storage.k8s.io
      resources:
      - csinodes
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - ""
      resources:
      - nodes
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - snapshot.storage.k8s.io
      resources:
      - volumesnapshots
      verbs:
      - get
      - list
    - apiGroups:
      - snapshot.storage.k8s.io
      resources:
      - volumesnapshotcontents
      verbs:
      - get
      - list
    - apiGroups:
      - storage.k8s.io
      resources:
      - volumeattachments
      verbs:
      - get
      - list
      - watch
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: csi-gce-pd-resizer-role
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    rules:
    - apiGroups:
      - ""
      resources:
      - persistentvolumes
      verbs:
      - get
      - list
      - watch
      - update
      - patch
    - apiGroups:
      - ""
      resources:
      - persistentvolumeclaims
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - ""
      resources:
      - persistentvolumeclaims/status
      verbs:
      - update
      - patch
    - apiGroups:
      - ""
      resources:
      - events
      verbs:
      - list
      - watch
      - create
      - update
      - patch
    - apiGroups:
      - ""
      resources:
      - pods
      verbs:
      - get
      - list
      - watch
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: csi-gce-pd-snapshotter-role
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    rules:
    - apiGroups:
      - ""
      resources:
      - events
      verbs:
      - list
      - watch
      - create
      - update
      - patch
    - apiGroups:
      - snapshot.storage.k8s.io
      resources:
      - volumesnapshotclasses
      verbs:
      - get
      - list
      - watch
    - apiGroups:
      - snapshot.storage.k8s.io
      resources:
      - volumesnapshotcontents
      verbs:
      - create
      - get
      - list
      - watch
      - update
      - delete
    - apiGroups:
      - snapshot.storage.k8s.io
      resources:
      - volumesnapshotcontents/status
      verbs:
      - update
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
      name: csi-gce-pd-controller-leaderelection-binding
      namespace: gce-pd-csi-driver
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: csi-gce-pd-leaderelection-role
    subjects:
    - kind: ServiceAccount
      name: csi-gce-pd-controller-sa
      namespace: gce-pd-csi-driver
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: csi-gce-pd-controller
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: csi-gce-pd-node-deploy
    subjects:
    - kind: ServiceAccount
      name: csi-gce-pd-controller-sa
      namespace: gce-pd-csi-driver
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: csi-gce-pd-controller-attacher-binding
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: csi-gce-pd-attacher-role
    subjects:
    - kind: ServiceAccount
      name: csi-gce-pd-controller-sa
      namespace: gce-pd-csi-driver
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: csi-gce-pd-controller-deploy
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: csi-gce-pd-controller-deploy
    subjects:
    - kind: ServiceAccount
      name: csi-gce-pd-controller-sa
      namespace: gce-pd-csi-driver
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: csi-gce-pd-controller-provisioner-binding
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: csi-gce-pd-provisioner-role
    subjects:
    - kind: ServiceAccount
      name: csi-gce-pd-controller-sa
      namespace: gce-pd-csi-driver
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: csi-gce-pd-controller-snapshotter-binding
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: csi-gce-pd-snapshotter-role
    subjects:
    - kind: ServiceAccount
      name: csi-gce-pd-controller-sa
      namespace: gce-pd-csi-driver
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: csi-gce-pd-node
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: csi-gce-pd-node-deploy
    subjects:
    - kind: ServiceAccount
      name: csi-gce-pd-node-sa
      namespace: gce-pd-csi-driver
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: csi-gce-pd-resizer-binding
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: csi-gce-pd-resizer-role
    subjects:
    - kind: ServiceAccount
      name: csi-gce-pd-controller-sa
      namespace: gce-pd-csi-driver
  - apiVersion: scheduling.k8s.io/v1
    description: This priority class should be used for the GCE PD CSI driver controller
      deployment only.
    globalDefault: false
    kind: PriorityClass
    metadata:
      name: csi-gce-pd-controller
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    value: 900000000
  - apiVersion: scheduling.k8s.io/v1
    description: This priority class should be used for the GCE PD CSI driver node deployment
      only.
    globalDefault: false
    kind: PriorityClass
    metadata:
      name: csi-gce-pd-node
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    value: 900001000
  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: csi-gce-pd-controller
      namespace: gce-pd-csi-driver
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: gcp-compute-persistent-disk-csi-driver
      template:
        metadata:
          labels:
            app: gcp-compute-persistent-disk-csi-driver
        spec:
          containers:
          - args:
            - --v=5
            - --csi-address=/csi/csi.sock
            - --feature-gates=Topology=true
            - --http-endpoint=:22011
            - --leader-election-namespace=$(PDCSI_NAMESPACE)
            - --timeout=250s
            - --extra-create-metadata
            - --leader-election
            - --default-fstype=ext4
            - --controller-publish-readonly=true
            env:
            - name: PDCSI_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            image: k8s.gcr.io/sig-storage/csi-provisioner:v3.1.0
            livenessProbe:
              failureThreshold: 1
              httpGet:
                path: /healthz/leader-election
                port: http-endpoint
              initialDelaySeconds: 10
              periodSeconds: 20
              timeoutSeconds: 10
            name: csi-provisioner
            ports:
            - containerPort: 22011
              name: http-endpoint
              protocol: TCP
            volumeMounts:
            - mountPath: /csi
              name: socket-dir
          - args:
            - --v=5
            - --csi-address=/csi/csi.sock
            - --http-endpoint=:22012
            - --leader-election
            - --leader-election-namespace=$(PDCSI_NAMESPACE)
            - --timeout=250s
            env:
            - name: PDCSI_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            image: k8s.gcr.io/sig-storage/csi-attacher:v3.4.0
            livenessProbe:
              failureThreshold: 1
              httpGet:
                path: /healthz/leader-election
                port: http-endpoint
              initialDelaySeconds: 10
              periodSeconds: 20
              timeoutSeconds: 10
            name: csi-attacher
            ports:
            - containerPort: 22012
              name: http-endpoint
              protocol: TCP
            volumeMounts:
            - mountPath: /csi
              name: socket-dir
          - args:
            - --v=5
            - --csi-address=/csi/csi.sock
            - --http-endpoint=:22013
            - --leader-election
            - --leader-election-namespace=$(PDCSI_NAMESPACE)
            - --handle-volume-inuse-error=false
            env:
            - name: PDCSI_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            image: k8s.gcr.io/sig-storage/csi-resizer:v1.4.0
            livenessProbe:
              failureThreshold: 1
              httpGet:
                path: /healthz/leader-election
                port: http-endpoint
              initialDelaySeconds: 10
              periodSeconds: 20
              timeoutSeconds: 10
            name: csi-resizer
            ports:
            - containerPort: 22013
              name: http-endpoint
              protocol: TCP
            volumeMounts:
            - mountPath: /csi
              name: socket-dir
          - args:
            - --v=5
            - --csi-address=/csi/csi.sock
            - --metrics-address=:22014
            - --leader-election
            - --leader-election-namespace=$(PDCSI_NAMESPACE)
            - --timeout=300s
            env:
            - name: PDCSI_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            image: k8s.gcr.io/sig-storage/csi-snapshotter:v4.0.1
            name: csi-snapshotter
            volumeMounts:
            - mountPath: /csi
              name: socket-dir
          - args:
            - --v=5
            - --endpoint=unix:/csi/csi.sock
            env:
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /etc/cloud-sa/cloud-sa.json
            image: k8s.gcr.io/cloud-provider-gcp/gcp-compute-persistent-disk-csi-driver:v1.7.1
            name: gce-pd-driver
            volumeMounts:
            - mountPath: /csi
              name: socket-dir
            - mountPath: /etc/cloud-sa
              name: cloud-sa-volume
              readOnly: true
          hostNetwork: true
          nodeSelector:
            kubernetes.io/os: linux
          priorityClassName: csi-gce-pd-controller
          serviceAccountName: csi-gce-pd-controller-sa
          volumes:
          - emptyDir: {}
            name: socket-dir
          - name: cloud-sa-volume
            secret:
              secretName: cloud-sa
  - apiVersion: apps/v1
    kind: DaemonSet
    metadata:
      name: csi-gce-pd-node
      namespace: gce-pd-csi-driver
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    spec:
      selector:
        matchLabels:
          app: gcp-compute-persistent-disk-csi-driver
      template:
        metadata:
          labels:
            app: gcp-compute-persistent-disk-csi-driver
        spec:
          containers:
          - args:
            - --v=5
            - --csi-address=/csi/csi.sock
            - --kubelet-registration-path=/var/data/kubelet/plugins/pd.csi.storage.gke.io/csi.sock
            env:
            - name: KUBE_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            image: k8s.gcr.io/sig-storage/csi-node-driver-registrar:v2.5.0
            livenessProbe:
              exec:
                command:
                - /csi-node-driver-registrar
                - --kubelet-registration-path=/var/data/kubelet/plugins/pd.csi.storage.gke.io/csi.sock
                - --mode=kubelet-registration-probe
              initialDelaySeconds: 3
            name: csi-driver-registrar
            volumeMounts:
            - mountPath: /csi
              name: plugin-dir
            - mountPath: /registration
              name: registration-dir
          - args:
            - --v=5
            - --endpoint=unix:/csi/csi.sock
            - --run-controller-service=false
            image: k8s.gcr.io/cloud-provider-gcp/gcp-compute-persistent-disk-csi-driver:v1.7.1
            name: gce-pd-driver
            securityContext:
              privileged: true
            volumeMounts:
            - mountPath: /var/data/kubelet
              mountPropagation: Bidirectional
              name: kubelet-dir
            - mountPath: /csi
              name: plugin-dir
            - mountPath: /dev
              name: device-dir
            - mountPath: /etc/udev
              name: udev-rules-etc
            - mountPath: /lib/udev
              name: udev-rules-lib
            - mountPath: /run/udev
              name: udev-socket
            - mountPath: /sys
              name: sys
          hostNetwork: true
          nodeSelector:
            kubernetes.io/os: linux
          priorityClassName: csi-gce-pd-node
          serviceAccountName: csi-gce-pd-node-sa
          tolerations:
          - operator: Exists
          volumes:
          - hostPath:
              path: /var/data/kubelet/plugins_registry/
              type: Directory
            name: registration-dir
          - hostPath:
              path: /var/data/kubelet
              type: Directory
            name: kubelet-dir
          - hostPath:
              path: /var/data/kubelet/plugins/pd.csi.storage.gke.io/
              type: DirectoryOrCreate
            name: plugin-dir
          - hostPath:
              path: /dev
              type: Directory
            name: device-dir
          - hostPath:
              path: /etc/udev
              type: Directory
            name: udev-rules-etc
          - hostPath:
              path: /lib/udev
              type: Directory
            name: udev-rules-lib
          - hostPath:
              path: /run/udev
              type: Directory
            name: udev-socket
          - hostPath:
              path: /sys
              type: Directory
            name: sys
  - apiVersion: storage.k8s.io/v1
    kind: CSIDriver
    metadata:
      name: pd.csi.storage.gke.io
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    spec:
      attachRequired: true
      podInfoOnMount: false
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: privileged-role
      namespace: gce-pd-csi-driver
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    rules:
    - apiGroups:
      - security.openshift.io
      resourceNames:
      - privileged
      resources:
      - securitycontextconstraints
      verbs:
      - use
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: privileged-rolebinding
      namespace: gce-pd-csi-driver
      labels:
        app.kubernetes.io/name: gcp-compute-persistent-disk-csi-driver
        app.kubernetes.io/version: 1.7.1
    subjects:
    - kind: ServiceAccount
      name: csi-gce-pd-controller-sa
      namespace:
    - kind: ServiceAccount
      name: csi-gce-pd-node-sa
      namespace:
    - kind: ServiceAccount
      name: csi-gce-pd-node-sa-win
      namespace:
    roleRef:
      kind: Role
      name: privileged-role
      apiGroup: rbac.authorization.k8s.io